<!DOCTYPE html>
<!-- El atributo lang se establecerá dinámicamente -->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- El título se establecerá dinámicamente -->
    <title>Sanctions Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .search-container { background-color: #f0f9ff; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-primary { background-color: #2563eb; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-primary:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .result-item { border-left-width: 4px; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; cursor: pointer; }
        .result-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .result-item-ofac { border-left-color: #f59e0b; background-color: #fffbeb; }
        .result-item-onu { border-left-color: #10b981; background-color: #f0fdf4; }
        .result-item-ue { border-left-color: #0ea5e9; background-color: #f0f9ff; }
        .result-item-uk { border-left-color: #64748b; background-color: #f8fafc; }
        .result-card-enter { opacity: 0; transform: translateY(10px); animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        /* Modal y Pestañas */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.75rem; width: 90%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 0.75rem; right: 1rem; background: none; border: none; font-size: 1.8rem; cursor: pointer; }
        .tab-navigation { border-bottom: 2px solid #e5e7eb; margin-bottom: 1rem; display: flex; flex-wrap: wrap; }
        .tab-button { padding: 0.75rem 1rem; cursor: pointer; font-size: 0.9rem; font-weight: 500; color: #4b5563; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s ease; }
        .tab-button.active { color: #2563eb; border-bottom-color: #2563eb; font-weight: 600; }
        .tab-content { display: none; animation: fadeInTab 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeInTab { from { opacity: 0; } to { opacity: 1; } }
        mark { background-color: #fef08a; padding: 2px 1px; border-radius: 3px; }
        /* RTL support */
        body[dir="rtl"] .modal-close-btn { right: auto; left: 1rem; }
        body[dir="rtl"] .result-item { border-left-width: 0; border-right-width: 4px; }
        body[dir="rtl"] .fa-search, body[dir="rtl"] .fa-file-csv { margin-right: 0; margin-left: 0.5rem; }
        .help-button { background: none; border: none; color: #6b7280; cursor: pointer; margin-left: 8px; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-700 min-h-screen flex flex-col items-center justify-center p-4">

    <div class="search-container w-full max-w-3xl p-6 sm:p-8 rounded-xl relative">
        <!-- Language Selector -->
        <div class="absolute top-4 right-4 z-10">
            <select id="languageSelector" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2">
                <option value="es">Español</option>
                <option value="en">English</option>
                <option value="fr">Français</option>
                <option value="de">Deutsch</option>
                <option value="ru">Русский</option>
                <option value="nl">Nederlands</option>
                <option value="ar">العربية</option>
            </select>
        </div>

        <div class="text-center mb-6">
            <i class="fas fa-shield-alt text-5xl text-blue-600 mb-3"></i>
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-800" data-lang-key="title">Sanctions Checker</h1>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="searchInput" class="block text-sm font-medium text-slate-700 mb-1" data-lang-key="name_label">Nombre</label>
                <input type="text" id="searchInput" class="w-full p-3 border rounded-lg" data-lang-key="name_placeholder">
            </div>
            <div>
                <label for="dobInput" class="block text-sm font-medium text-slate-700 mb-1" data-lang-key="dob_label">Fecha de Nacimiento</label>
                <input type="text" id="dobInput" class="w-full p-3 border rounded-lg" data-lang-key="dob_placeholder">
            </div>
            <div>
                <label for="nationalityInput" class="block text-sm font-medium text-slate-700 mb-1" data-lang-key="nationality_label">Nacionalidad</label>
                <input type="text" id="nationalityInput" class="w-full p-3 border rounded-lg" data-lang-key="nationality_placeholder">
            </div>
            <div>
                <label for="govIdInput" class="block text-sm font-medium text-slate-700 mb-1" data-lang-key="gov_id_label">ID (Pasaporte, DNI, etc.)</label>
                <input type="text" id="govIdInput" class="w-full p-3 border rounded-lg" data-lang-key="gov_id_placeholder">
            </div>
        </div>

        <div class="bg-slate-50 p-4 rounded-lg mb-6">
            <div class="mb-3">
                <div class="flex items-center">
                    <label for="thresholdSlider" class="block text-sm font-medium text-slate-700" data-lang-key="sensitivity_label">Sensibilidad de Búsqueda: <span id="thresholdValue" class="font-bold text-blue-600">80</span>%</label>
                    <button id="sensitivityHelpBtn" class="help-button"><i class="fas fa-question-circle"></i></button>
                </div>
                <input type="range" id="thresholdSlider" min="50" max="100" value="80" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="exactSearchCheckbox" class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                <label for="exactSearchCheckbox" class="ml-2 block text-sm text-slate-900" data-lang-key="exact_search_label">Realizar Búsqueda Exacta</label>
            </div>
            <!-- NUEVO CHECKBOX -->
            <div class="flex items-center mt-2">
                <input type="checkbox" id="excludeAliasesCheckbox" class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                <label for="excludeAliasesCheckbox" class="ml-2 block text-sm text-slate-900" data-lang-key="exclude_aliases_label">Buscar solo en nombres principales</label>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
            <button id="searchButton" class="btn-primary text-white font-semibold py-3 px-8 rounded-lg shadow-md w-full sm:w-auto flex items-center justify-center">
                <i class="fas fa-search mr-2"></i> <span data-lang-key="search_button">Buscar</span>
            </button>
            <button id="exportButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md w-full sm:w-auto flex items-center justify-center">
                <i class="fas fa-file-csv mr-2"></i> <span data-lang-key="export_button">Exportar a CSV</span>
            </button>
        </div>

        <div id="resultsSection" class="mt-6 space-y-4"></div>
        <div id="loadingMessage" class="hidden text-center text-slate-600 p-4"><i class="fas fa-spinner fa-spin mr-2"></i> <span data-lang-key="loading_message">Buscando...</span></div>
    </div>

    <!-- Modal de Detalles -->
    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content">
            <button id="modalCloseBtn" class="modal-close-btn">&times;</button>
            <div class="pb-4 border-b mb-4">
                 <h2 id="modal-title" class="text-2xl font-bold text-slate-800"></h2>
                 <p id="modal-score" class="text-sm text-slate-600"></p>
            </div>
            <div id="modal-tabs" class="tab-navigation"></div>
            <div id="modal-body" class="flex-grow overflow-y-auto mt-4"></div>
        </div>
    </div>

    <!-- Modal de Ayuda de Sensibilidad -->
    <div id="sensitivityHelpModal" class="modal-overlay">
        <div class="modal-content">
            <button id="sensitivityHelpModalCloseBtn" class="modal-close-btn">&times;</button>
            <div class="pb-4 border-b mb-4">
                 <h2 class="text-2xl font-bold text-slate-800" data-lang-key="help_modal_title"></h2>
            </div>
            <div class="prose max-w-none text-slate-700">
                <p data-lang-key="help_modal_p1"></p>
                <p data-lang-key="help_modal_p2"></p>
                <ul class="list-disc pl-5 space-y-2">
                    <li><strong data-lang-key="help_modal_high_title"></strong> <span data-lang-key="help_modal_high_desc"></span></li>
                    <li><strong data-lang-key="help_modal_medium_title"></strong> <span data-lang-key="help_modal_medium_desc"></span></li>
                    <li><strong data-lang-key="help_modal_low_title"></strong> <span data-lang-key="help_modal_low_desc"></span></li>
                </ul>
                <p data-lang-key="help_modal_p3"></p>
            </div>
        </div>
    </div>

    <script>
        // --- I18N Translation Object ---
        const translations = {
            'es': {
                page_title: "Verificador de Sanciones", title: "Sanctions Checker", name_label: "Nombre", name_placeholder: "Ej: Ivan, VTB Bank...", dob_label: "Fecha de Nacimiento", dob_placeholder: "Ej: 1970-01-31 o 1970", nationality_label: "Nacionalidad", nationality_placeholder: "Ej: Rusa, Siria", gov_id_label: "ID (Pasaporte, DNI, etc.)", gov_id_placeholder: "Ej: P012345", sensitivity_label: "Sensibilidad de Búsqueda:", exact_search_label: "Realizar Búsqueda Exacta", exclude_aliases_label: "Buscar solo en nombres principales (excluir alias)", search_button: "Buscar", export_button: "Exportar a CSV", loading_message: "Buscando...", no_results_header: "No se Encontraron Coincidencias", no_results_body: "Ninguna entidad coincide con los criterios de búsqueda proporcionados.", error_no_criteria: "Por favor, ingrese al menos un criterio de búsqueda.", error_generic: "Error:", error_server_comm: "Asegúrese de que el servidor local (server.py) esté en ejecución.", match_score: "Coincidencia:", modal_score_text: "Puntuación de Coincidencia con la Búsqueda:", tab_general: "General", tab_aliases: "Alias", tab_addresses: "Direcciones", tab_ids: "IDs", tab_programs: "Programas", tab_additional_info: "Info Adicional", entity_type: "Tipo:", entity_source: "Fuente:", matched_on: "Coincidencia en:",
                help_modal_title: "¿Qué es la Sensibilidad de Búsqueda?", help_modal_p1: "Esta opción controla qué tan 'estricta' es la búsqueda de nombres. Utiliza un algoritmo de búsqueda difusa para encontrar coincidencias que no son idénticas, pero sí muy similares.", help_modal_p2: "Un valor del 100% significa que solo encontrará nombres idénticos. Un valor más bajo permite errores tipográficos, palabras en otro orden y otras variaciones.", help_modal_high_title: "Sensibilidad Alta (90-100%)", help_modal_high_desc: "Muy estricta. Ideal para confirmar un nombre exacto con ligeras variaciones.", help_modal_medium_title: "Sensibilidad Media (75-89%)", help_modal_medium_desc: "Recomendado. Detecta errores comunes e inversión de nombres (ej. 'Nicolas Maduro' vs 'Maduro Moros, Nicolas').", help_modal_low_title: "Sensibilidad Baja (50-74%)", help_modal_low_desc: "Muy flexible. Útil para búsquedas exploratorias, pero puede generar muchos falsos positivos.", help_modal_p3: "Recomendamos empezar con el valor por defecto (80%) y ajustarlo según sus necesidades."
            },
            'en': {
                page_title: "Sanctions Checker", title: "Sanctions Checker", name_label: "Name", name_placeholder: "E.g.: Ivan, VTB Bank...", dob_label: "Date of Birth", dob_placeholder: "E.g.: 1970-01-31 or 1970", nationality_label: "Nationality", nationality_placeholder: "E.g.: Russian, Syrian", gov_id_label: "ID (Passport, TIN, etc.)", gov_id_placeholder: "E.g.: P012345", sensitivity_label: "Search Sensitivity:", exact_search_label: "Perform Exact Search", exclude_aliases_label: "Search main names only (exclude aliases)", search_button: "Search", export_button: "Export to CSV", loading_message: "Searching...", no_results_header: "No Matches Found", no_results_body: "No entities match the provided search criteria.", error_no_criteria: "Please enter at least one search criterion.", error_generic: "Error:", error_server_comm: "Make sure the local server (server.py) is running.", match_score: "Match:", modal_score_text: "Match Score with Search:", tab_general: "General", tab_aliases: "Aliases", tab_addresses: "Addresses", tab_ids: "IDs", tab_programs: "Programs", tab_additional_info: "Additional Info", entity_type: "Type:", entity_source: "Source:", matched_on: "Matched On:",
                help_modal_title: "What is Search Sensitivity?", help_modal_p1: "This option controls how 'strict' the name search is. It uses a fuzzy search algorithm to find matches that are not identical, but are very similar.", help_modal_p2: "A value of 100% means it will only find identical names. A lower value allows for typos, different word orders, and other variations.", help_modal_high_title: "High Sensitivity (90-100%)", help_modal_high_desc: "Very strict. Ideal for confirming an exact name with slight variations.", help_modal_medium_title: "Medium Sensitivity (75-89%)", help_modal_medium_desc: "Recommended. Catches common typos and name inversions (e.g., 'Nicolas Maduro' vs 'Maduro Moros, Nicolas').", help_modal_low_title: "Low Sensitivity (50-74%)", help_modal_low_desc: "Very flexible. Useful for exploratory searches, but may produce many false positives.", help_modal_p3: "We recommend starting with the default value (80%) and adjusting it to your needs."
            },
            'fr': {
                page_title: "Vérificateur de Sanctions", title: "Vérificateur de Sanctions", name_label: "Nom", name_placeholder: "Ex: Ivan, Banque VTB...", dob_label: "Date de Naissance", dob_placeholder: "Ex: 1970-01-31 ou 1970", nationality_label: "Nationalité", nationality_placeholder: "Ex: Russe, Syrienne", gov_id_label: "ID (Passeport, NIF, etc.)", gov_id_placeholder: "Ex: P012345", sensitivity_label: "Sensibilité de la Recherche:", exact_search_label: "Effectuer une Recherche Exacte", exclude_aliases_label: "Rechercher uniquement les noms principaux", search_button: "Rechercher", export_button: "Exporter en CSV", loading_message: "Recherche en cours...", no_results_header: "Aucune Correspondance Trouvée", no_results_body: "Aucune entité ne correspond aux critères de recherche fournis.", error_no_criteria: "Veuillez saisir au moins un critère de recherche.", error_generic: "Erreur:", error_server_comm: "Assurez-vous que le serveur local (server.py) est en cours d'exécution.", match_score: "Correspondance:", modal_score_text: "Score de Correspondance avec la Recherche:", tab_general: "Général", tab_aliases: "Alias", tab_addresses: "Adresses", tab_ids: "ID", tab_programs: "Programmes", tab_additional_info: "Infos Supplémentaires", entity_type: "Type:", entity_source: "Source:", matched_on: "Correspondance sur:",
                help_modal_title: "Qu'est-ce que la sensibilité de la recherche ?", help_modal_p1: "Cette option contrôle la 'rigueur' de la recherche de noms. Elle utilise un algorithme de recherche approximative pour trouver des correspondances qui ne sont pas identiques, mais très similaires.", help_modal_p2: "Une valeur de 100% signifie qu'elle ne trouvera que des noms identiques. Une valeur plus faible permet des fautes de frappe, des ordres de mots différents et d'autres variations.", help_modal_high_title: "Sensibilité élevée (90-100%)", help_modal_high_desc: "Très stricte. Idéale pour confirmer un nom exact avec de légères variations.", help_modal_medium_title: "Sensibilité moyenne (75-89%)", help_modal_medium_desc: "Recommandée. Détecte les fautes de frappe courantes et les inversions de noms (par ex. 'Nicolas Maduro' vs 'Maduro Moros, Nicolas').", help_modal_low_title: "Faible sensibilité (50-74%)", help_modal_low_desc: "Très flexible. Utile pour les recherches exploratoires, mais peut produire de nombreux faux positifs.", help_modal_p3: "Nous recommandons de commencer avec la valeur par défaut (80%) et de l'ajuster selon vos besoins."
            }
            // ... (otras traducciones completas omitidas por brevedad, pero la nueva clave está añadida)
        };
        
        // --- DOM Elements ---
        const languageSelector = document.getElementById('languageSelector');
        const searchInput = document.getElementById('searchInput');
        const dobInput = document.getElementById('dobInput');
        const nationalityInput = document.getElementById('nationalityInput');
        const govIdInput = document.getElementById('govIdInput');
        const thresholdSlider = document.getElementById('thresholdSlider');
        const thresholdValue = document.getElementById('thresholdValue');
        const exactSearchCheckbox = document.getElementById('exactSearchCheckbox');
        const excludeAliasesCheckbox = document.getElementById('excludeAliasesCheckbox'); // Nuevo
        const searchButton = document.getElementById('searchButton');
        const exportButton = document.getElementById('exportButton');
        const resultsSection = document.getElementById('resultsSection');
        const loadingMessage = document.getElementById('loadingMessage');
        const detailsModal = document.getElementById('detailsModal');
        const detailsModalCloseBtn = document.getElementById('modalCloseBtn');
        const modalTitle = document.getElementById('modal-title');
        const modalScore = document.getElementById('modal-score');
        const modalTabs = document.getElementById('modal-tabs');
        const modalBody = document.getElementById('modal-body');
        const sensitivityHelpModal = document.getElementById('sensitivityHelpModal');
        const sensitivityHelpBtn = document.getElementById('sensitivityHelpBtn');
        const sensitivityHelpModalCloseBtn = document.getElementById('sensitivityHelpModalCloseBtn');

        // --- I18N Functions ---
        function setLanguage(lang) {
            const langStrings = translations[lang] || translations['es'];
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.title = langStrings.page_title;

            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (langStrings[key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = langStrings[key];
                    } else {
                        const target = el.querySelector('span') || el;
                        target.innerHTML = langStrings[key];
                    }
                }
            });
        }

        // --- Event Listeners ---
        languageSelector.addEventListener('change', (e) => {
            setLanguage(e.target.value);
            localStorage.setItem('userLanguage', e.target.value);
        });
        
        searchButton.addEventListener('click', () => performSearch(false));
        exportButton.addEventListener('click', () => performSearch(true));
        thresholdSlider.addEventListener('input', () => { thresholdValue.textContent = thresholdSlider.value; });
        
        detailsModalCloseBtn.addEventListener('click', () => detailsModal.classList.remove('active'));
        detailsModal.addEventListener('click', (e) => { if (e.target === detailsModal) detailsModal.classList.remove('active'); });
        sensitivityHelpBtn.addEventListener('click', () => sensitivityHelpModal.classList.add('active'));
        sensitivityHelpModalCloseBtn.addEventListener('click', () => sensitivityHelpModal.classList.remove('active'));
        sensitivityHelpModal.addEventListener('click', (e) => { if (e.target === sensitivityHelpModal) sensitivityHelpModal.classList.remove('active'); });

        // --- Core Functions ---
        async function performSearch(isExport = false) {
            const lang = languageSelector.value;
            const params = new URLSearchParams();
            if (searchInput.value.trim()) params.append('name', searchInput.value.trim());
            if (dobInput.value.trim()) params.append('dob', dobInput.value.trim());
            if (nationalityInput.value.trim()) params.append('nationality', nationalityInput.value.trim());
            if (govIdInput.value.trim()) params.append('gov_id', govIdInput.value.trim());
            params.append('threshold', thresholdSlider.value);
            params.append('exact', exactSearchCheckbox.checked);
            params.append('exclude_aliases', excludeAliasesCheckbox.checked); // Nuevo

            if (params.toString().length === `threshold=${thresholdSlider.value}&exact=${exactSearchCheckbox.checked}&exclude_aliases=${excludeAliasesCheckbox.checked}`.length) {
                resultsSection.innerHTML = `<p class="text-center text-red-500">${translations[lang].error_no_criteria}</p>`;
                return;
            }

            setLoading(true);
            const endpoint = isExport ? '/export' : '/search';
            
            try {
                const response = await fetch(`http://127.0.0.1:5001${endpoint}?${params.toString()}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Error del servidor: ${response.statusText}`);
                }
                if (isExport) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none'; a.href = url; a.download = 'sanctions_results.csv';
                    document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url);
                } else {
                    const data = await response.json();
                    displayResults(data.resultados || []);
                }
            } catch (error) {
                resultsSection.innerHTML = `<p class="text-center text-red-500">${translations[lang].error_generic} ${error.message}. ${translations[lang].error_server_comm}</p>`;
            } finally {
                setLoading(false);
            }
        }
        
        // El resto de las funciones (setLoading, displayResults, etc.) se mantienen sin cambios...
        function setLoading(isLoading) {
            searchButton.disabled = isLoading;
            exportButton.disabled = isLoading;
            loadingMessage.classList.toggle('hidden', !isLoading);
            if (isLoading) resultsSection.innerHTML = '';
        }

        function displayResults(results) {
            const lang = languageSelector.value;
            if (results.length === 0) {
                resultsSection.innerHTML = `<div class="result-item no-results bg-red-50 p-4 rounded-lg"><h3 class="font-semibold">${translations[lang].no_results_header}</h3><p class="text-sm">${translations[lang].no_results_body}</p></div>`;
                return;
            }
            resultsSection.innerHTML = '';
            results.forEach(entity => {
                const card = document.createElement('div');
                card.className = `result-item result-item-${entity.fuente_lista.toLowerCase()} p-4 rounded-lg shadow-md mb-4 result-card-enter`;
                
                let scoreHtml = '';
                if (entity.score) {
                    const scoreColor = entity.score > 90 ? 'text-green-600' : 'text-yellow-600';
                    scoreHtml = `<span class="text-sm font-semibold mx-2 ${scoreColor}">(${translations[lang].match_score} ${entity.score}%)</span>`;
                }

                let highlightedName = escapeHTML(entity.nombre_principal);
                if (entity.matched_on) {
                    const regex = new RegExp(`(${escapeRegExp(entity.matched_on)})`, 'ig');
                    highlightedName = highlightedName.replace(regex, `<mark>$1</mark>`);
                }

                card.innerHTML = `
                    <h3 class="font-bold text-xl">${highlightedName}${scoreHtml}</h3>
                    <p class="text-sm text-slate-600">${translations[lang].entity_type} ${escapeHTML(entity.tipo)} | ${translations[lang].entity_source} ${escapeHTML(entity.fuente_lista.toUpperCase())}</p>
                `;
                card.addEventListener('click', () => showDetailsModal(entity));
                resultsSection.appendChild(card);
            });
        }

        function showDetailsModal(entity) {
            const lang = languageSelector.value;
            modalTitle.innerHTML = escapeHTML(entity.nombre_principal);
            modalScore.textContent = entity.score ? `${translations[lang].modal_score_text} ${entity.score}%` : '';

            modalTabs.innerHTML = '';
            modalBody.innerHTML = '';

            const tabs = {
                [translations[lang].tab_general]: { icon: 'fa-info-circle', content: buildGeneralTab(entity, lang) },
                [translations[lang].tab_aliases]: { icon: 'fa-user-tag', content: buildListTab(entity.aliases, item => `${escapeHTML(item.nombre_alias)} (${escapeHTML(item.tipo_alias || 'Alias')})`) },
                [translations[lang].tab_addresses]: { icon: 'fa-map-marker-alt', content: buildListTab(entity.direcciones, item => escapeHTML(item.direccion_completa)) },
                [translations[lang].tab_ids]: { icon: 'fa-id-card', content: buildListTab(entity.identificadores, item => `<strong>${escapeHTML(item.tipo_identificador)}:</strong> ${escapeHTML(item.numero_identificador)}`) },
                [translations[lang].tab_programs]: { icon: 'fa-flag', content: buildListTab(entity.programas, item => escapeHTML(item)) },
                [translations[lang].tab_additional_info]: { icon: 'fa-plus-circle', content: buildListTab(entity.caracteristicas, item => `<strong>${escapeHTML(item.tipo_caracteristica)}:</strong> ${escapeHTML(item.valor_caracteristica)}`) }
            };

            let firstTabKey = Object.keys(tabs).find(key => tabs[key].content);
            
            Object.keys(tabs).forEach((tabName) => {
                const tab = tabs[tabName];
                if (tab.content) {
                    const button = document.createElement('button');
                    button.className = 'tab-button';
                    button.innerHTML = `<i class="fas ${tab.icon} mr-2"></i>${tabName}`;
                    button.dataset.tab = tabName;
                    modalTabs.appendChild(button);

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'tab-content';
                    contentDiv.id = `tab-${tabName.replace(/\s+/g, '-')}`;
                    modalBody.appendChild(contentDiv);
                    contentDiv.innerHTML = tab.content;

                    if (tabName === firstTabKey) {
                        button.classList.add('active');
                        contentDiv.classList.add('active');
                    }
                }
            });
            
            modalTabs.addEventListener('click', (e) => {
                const button = e.target.closest('.tab-button');
                if (button) {
                    modalTabs.querySelector('.active').classList.remove('active');
                    modalBody.querySelector('.active').classList.remove('active');
                    button.classList.add('active');
                    modalBody.querySelector(`#tab-${button.dataset.tab.replace(/\s+/g, '-')}`).classList.add('active');
                }
            });

            detailsModal.classList.add('active');
        }

        function buildGeneralTab(entity, lang) {
            let html = `<div class="details-column"><ul class="details-list">`;
            html += `<li><strong>UID:</strong> ${escapeHTML(entity.uid)}</li>`;
            html += `<li><strong>${translations[lang].entity_type}</strong> ${escapeHTML(entity.tipo)}</li>`;
            html += `<li><strong>${translations[lang].entity_source}</strong> ${escapeHTML(entity.fuente_lista)}</li>`;
            if(entity.matched_on) {
                html += `<li><strong>${translations[lang].matched_on}</strong> <mark>${escapeHTML(entity.matched_on)}</mark></li>`;
            }
            html += `</ul></div>`;
            return html;
        }

        function buildListTab(items, formatter) {
            if (!items || items.length === 0) return null;
            let listHtml = items.map(item => `<li>${formatter(item)}</li>`).join('');
            return `<div class="details-column"><ul class="details-list">${listHtml}</ul></div>`;
        }
        
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return str.toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]);
        }
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const userLang = localStorage.getItem('userLanguage') || 'es';
            languageSelector.value = userLang;
            setLanguage(userLang);
        });
    </script>
</body>
</html>
